import{j as e,r as y}from"./index-Damo5oZI.js";import{D as A,I as P,B as z,u as I,a as L,o as U,s as F,_ as B}from"./zod-DCjnlhOv.js";import{a as j}from"./api-DhFjHDpY.js";function T({access:o}){const r={nda:{label:"NDA",color:"#EF4444"},portal:{label:"Portal",color:"#F59E0B"},public:{label:"Public",color:"#10B981"}}[o];return e.jsx("span",{style:{display:"inline-block",padding:"2px 8px",borderRadius:999,border:"1px solid #334",color:r.color,background:"#0E1621",fontSize:12},children:r.label})}const V=[],N=U({name:F().min(1,"Name required"),type:B(["PDF","Video","Image","Other"]),cat:B(["NDA","Spec","Report","Marketing"]),vis:B(["Public","Dealer","Admin"]),url:F().url("Invalid URL"),desc:F().optional()});function D(o){const i=["B","KB","MB","GB","TB"];let r=o,n=0;for(;r>=1024&&n<i.length-1;)r/=1024,n++;return`${r.toFixed(r>=10||n===0?0:1)}${i[n]}`}function q(){const[o,i]=y.useState(V),[r,n]=y.useState(""),[u,b]=y.useState(""),[x,k]=y.useState(""),[h,R]=y.useState(""),[c,w]=y.useState([]),[f,a]=y.useState(null);y.useEffect(()=>{(async()=>{try{const s=new URLSearchParams;r&&s.set("q",r),u&&s.set("type",u),x&&s.set("cat",x),h&&s.set("vis",h);const d=await j.get(`/files?${s.toString()}`);if(Array.isArray(d==null?void 0:d.items)){const p=d.items.map(l=>({id:String(l.id),name:l.name,type:l.type,cat:l.cat,vis:l.vis,url:l.url,desc:l.desc,size:typeof l.size=="number"&&l.size>0?D(l.size):l.size||"-",updated:(l.updatedAt||l.createdAt||new Date().toISOString()).slice(0,10)}));i(p)}}catch{}})()},[r,u,x,h]);const g=y.useMemo(()=>{let t=[...o];return r&&(t=t.filter(s=>[s.name,s.cat,s.type,s.vis].some(d=>String(d).toLowerCase().includes(r.toLowerCase())))),u&&(t=t.filter(s=>s.type===u)),x&&(t=t.filter(s=>s.cat===x)),h&&(t=t.filter(s=>s.vis===h)),t},[o,r,u,x,h]),C=async()=>{if(c.length===0)return alert("Select rows first");if(!confirm(`Delete ${c.length} file(s)?`))return;const t=[...c],s=o;i(d=>d.filter(p=>!t.includes(p.id))),w([]);try{t.length===1?await j.del(`/files/${t[0]}`):await j.post("/files/bulk-delete",{ids:t})}catch{i(s),alert("Failed to delete")}},m=t=>{navigator.clipboard.writeText(t),alert("Link copied")},E=[{key:"select",header:"",render:t=>e.jsx("input",{type:"checkbox",checked:c.includes(t.id),onChange:s=>w(d=>s.target.checked?[...d,t.id]:d.filter(p=>p!==t.id))})},...[{key:"name",header:"File Name"},{key:"type",header:"Type"},{key:"cat",header:"Category"},{key:"vis",header:"Visibility",render:t=>e.jsx(T,{access:t.vis==="Dealer"?"portal":t.vis==="Admin"?"nda":"public"})},{key:"size",header:"Size"},{key:"updated",header:"Updated"},{key:"actions",header:"",render:t=>e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{onClick:s=>{s.stopPropagation(),a({id:t.id})},style:{padding:"4px 8px"},children:"Edit"}),e.jsx("button",{onClick:s=>{s.stopPropagation(),m(t.url)},style:{padding:"4px 8px"},children:"Copy Link"}),e.jsx("button",{onClick:async s=>{if(s.stopPropagation(),!confirm("Delete file?"))return;const d=o;i(p=>p.filter(l=>l.id!==t.id));try{await j.del(`/files/${t.id}`)}catch{i(d),alert("Failed to delete")}},style:{padding:"4px 8px"},children:"Delete"})]})}]],S=e.jsxs("div",{style:{display:"flex",alignItems:"end",justifyContent:"space-between",gap:12,flexWrap:"wrap",padding:12,borderBottom:"1px solid #223",background:"#0E1621"},children:[e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx(P,{label:"Search",value:r,onChange:t=>n(t.target.value),placeholder:"Name, type, category"}),e.jsxs("label",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"#C5C6C7"},children:"Type"}),e.jsxs("select",{value:u,onChange:t=>b(t.target.value||""),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{children:"PDF"}),e.jsx("option",{children:"Video"}),e.jsx("option",{children:"Image"}),e.jsx("option",{children:"Other"})]})]}),e.jsxs("label",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"#C5C6C7"},children:"Category"}),e.jsxs("select",{value:x,onChange:t=>k(t.target.value||""),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{children:"NDA"}),e.jsx("option",{children:"Spec"}),e.jsx("option",{children:"Report"}),e.jsx("option",{children:"Marketing"})]})]}),e.jsxs("label",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"#C5C6C7"},children:"Visibility"}),e.jsxs("select",{value:h,onChange:t=>R(t.target.value||""),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{children:"Public"}),e.jsx("option",{children:"Dealer"}),e.jsx("option",{children:"Admin"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(z,{onClick:()=>a({}),children:"Add File"}),e.jsx(z,{onClick:C,variant:"ghost",children:"Delete"})]})]});return e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsx("h1",{children:"Files"}),e.jsx(A,{columns:E,rows:g,density:"compact",toolbar:S,onRowClick:t=>a({id:t.id})}),f&&e.jsx(O,{initial:f.id?o.find(t=>t.id===f.id):void 0,onClose:()=>a(null),onSave:async t=>{if(f.id){const s=f.id,d=o;i(p=>p.map(l=>l.id===s?{...l,...t,updated:new Date().toISOString().slice(0,10)}:l));try{await j.patch(`/files/${s}`,t)}catch{i(d),alert("Failed to save")}}else try{const s=await j.post("/files",t),d={id:String(s.id),name:s.name,type:s.type,cat:s.cat,vis:s.vis,url:s.url,desc:s.desc,size:typeof s.size=="number"&&s.size>0?D(s.size):s.size||"-",updated:(s.updatedAt||s.createdAt||new Date().toISOString()).slice(0,10)};i(p=>[d,...p])}catch{alert("Failed to create file")}a(null)}})]})}function O({initial:o,onClose:i,onSave:r}){const{register:n,handleSubmit:u,formState:{errors:b,isSubmitting:x},setValue:k,watch:h}=I({resolver:L(N),defaultValues:{name:(o==null?void 0:o.name)??"",type:(o==null?void 0:o.type)??"PDF",cat:(o==null?void 0:o.cat)??"Spec",vis:(o==null?void 0:o.vis)??"Public",url:(o==null?void 0:o.url)??"",desc:(o==null?void 0:o.desc)??""}}),R=a=>{if(String(a.url||"").startsWith("blob:")){alert("Please provide a real URL (https://...) or re-upload successfully. Blob URLs cannot be saved.");return}r(a)},c=h("url"),w=(c==null?void 0:c.match(/\.(png|jpg|jpeg|gif|webp)$/i))||c.startsWith("blob:"),f=async a=>{if(!a||a.length===0)return;const g=a[0],C=g.type||"application/octet-stream";try{const m=await j.post("/uploads/signed-url",{filename:g.name,contentType:C,size:g.size});await fetch(m.uploadUrl,{method:"PUT",headers:{"Content-Type":C},body:g});const v=await j.post("/uploads/complete",{objectKey:m.objectKey,metadata:{contentType:C,size:g.size}}),E=(v==null?void 0:v.publicUrl)||"";E&&k("url",E);const S=(g.name.split(".").pop()||"").toLowerCase(),t=S==="pdf"?"PDF":["mp4","mov","webm"].includes(S)?"Video":["png","jpg","jpeg","gif","webp"].includes(S)?"Image":"Other";k("type",t)}catch{alert("Upload failed. Please try again or paste a direct URL to a hosted file. Blob URLs cannot be used.");const m=(g.name.split(".").pop()||"").toLowerCase(),v=m==="pdf"?"PDF":["mp4","mov","webm"].includes(m)?"Video":["png","jpg","jpeg","gif","webp"].includes(m)?"Image":"Other";k("type",v)}};return e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"grid",placeItems:"center",zIndex:60},children:e.jsxs("form",{onSubmit:u(R),style:{background:"#0E1621",border:"1px solid #223",borderRadius:16,width:600,maxWidth:"96vw",padding:18,display:"grid",gap:12,maxHeight:"90vh",overflowY:"auto"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("strong",{style:{fontSize:16},children:o?"Edit File":"Add File"}),e.jsx("button",{type:"button",onClick:i,style:{background:"transparent",border:"1px solid #334",borderRadius:8,color:"#C5C6C7",padding:"6px 10px"},children:"Close"})]}),e.jsxs("label",{children:["Name",e.jsx("input",{...n("name"),style:{padding:"10px 12px",borderRadius:8,border:"1px solid "+(b.name?"#AA2E2E":"#334"),background:"#0B1117",color:"#E6E6E6"}}),b.name&&e.jsx("small",{style:{color:"#FF6B6B"},children:b.name.message})]}),e.jsxs("label",{children:["Type",e.jsxs("select",{...n("type"),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:[e.jsx("option",{children:"PDF"}),e.jsx("option",{children:"Video"}),e.jsx("option",{children:"Image"}),e.jsx("option",{children:"Other"})]})]}),e.jsxs("label",{children:["Category",e.jsxs("select",{...n("cat"),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:[e.jsx("option",{children:"NDA"}),e.jsx("option",{children:"Spec"}),e.jsx("option",{children:"Report"}),e.jsx("option",{children:"Marketing"})]})]}),e.jsxs("label",{children:["Visibility",e.jsxs("select",{...n("vis"),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:[e.jsx("option",{children:"Public"}),e.jsx("option",{children:"Dealer"}),e.jsx("option",{children:"Admin"})]})]}),e.jsxs("div",{style:{display:"grid",gap:8},children:[e.jsxs("label",{children:["Upload File",e.jsx("input",{type:"file",onChange:a=>f(a.target.files),style:{marginTop:6}})]}),w?e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:12,color:"#9aa4af",marginBottom:6},children:"Preview"}),e.jsx("img",{src:c,alt:"preview",style:{width:120,height:120,objectFit:"cover",borderRadius:8,border:"1px solid #223"}})]}):c?e.jsxs("div",{style:{fontSize:12,color:"#9aa4af"},children:["URL set: ",c.slice(0,60),c.length>60?"â€¦":""]}):null]}),e.jsxs("label",{children:["URL",e.jsx("input",{...n("url"),style:{padding:"10px 12px",borderRadius:8,border:"1px solid "+(b.url?"#AA2E2E":"#334"),background:"#0B1117",color:"#E6E6E6"}}),b.url&&e.jsx("small",{style:{color:"#FF6B6B"},children:b.url.message})]}),e.jsxs("label",{children:["Description",e.jsx("textarea",{rows:3,...n("desc"),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"}})]}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",onClick:i,style:{padding:"8px 12px",border:"1px solid #334",borderRadius:8},children:"Cancel"}),e.jsx("button",{disabled:x,type:"submit",style:{padding:"8px 12px",border:"1px solid #334",borderRadius:8,background:"var(--accent)",color:"#fff"},children:o?"Save":"Create"})]})]})})}export{q as default};
