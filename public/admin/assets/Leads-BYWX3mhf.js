import{r as d,j as e}from"./index-Damo5oZI.js";import{D as X,B as C,I as Y,u as P,a as T,o as Z,s as g,_ as M,b as ee}from"./zod-DCjnlhOv.js";import{D as se}from"./Drawer-mjPiPrwt.js";import{S as N}from"./StatusBadge-871Fm8_w.js";import{a as b}from"./api-DhFjHDpY.js";const F=Z({name:g().min(1,"Name is required").max(80),email:g().email("Invalid email"),phone:g().optional(),company:g().optional(),country:g().optional(),type:M(["Prototype","Dealer","Media","Other"]),message:g().max(5e3).optional(),tags:ee(g()).optional(),status:M(["New","In Review","Qualified","Closed"]),owner:g().optional()});function te(l){const p=["Name","Email","Company","Type","Status","Created"],r=l.map(o=>[o.name,o.email,o.company||"",o.type,o.status,o.createdAt]);return[p,...r].map(o=>o.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(",")).join(`
`)}const ae=[];function he(){const[l,p]=d.useState(""),[r,o]=d.useState(""),[c,f]=d.useState(""),[h,v]=d.useState(""),[x,w]=d.useState(""),[m,u]=d.useState(ae),[S,I]=d.useState([]),[U,k]=d.useState(!1),[i,R]=d.useState(null),[B,E]=d.useState(!1),[Q,D]=d.useState(!1),[ie,re]=d.useState([{name:"Default",filter:{}}]),[z,L]=d.useState(null),[V,oe]=d.useState(!1);d.useEffect(()=>{(async()=>{try{const t=new URLSearchParams;l&&t.set("q",l),r&&t.set("status",r),c&&t.set("type",c),h&&t.set("from",h),x&&t.set("to",x);const a=await b.get(`/leads?${t.toString()}`);Array.isArray(a==null?void 0:a.items)&&u(a.items)}catch{}})()},[l,r,c,h,x]);const A=async(s,t)=>{u(a=>a.map(n=>n.id===s?{...n,status:t}:n)),i&&i.id===s&&R({...i,status:t});try{await b.patch(`/leads/${s}/status`,{status:t})}catch{}},$=async s=>{if(!confirm("Delete this lead?"))return;const t=m;u(a=>a.filter(n=>n.id!==s));try{await b.del(`/leads/${s}`)}catch{u(t),alert("Failed to delete lead")}i&&i.id===s&&(k(!1),R(null))},O=d.useMemo(()=>{let s=[...m];if(l){const n=l.toLowerCase();s=s.filter(j=>[j.name,j.email,j.company].some(K=>(K||"").toLowerCase().includes(n)))}r&&(s=s.filter(n=>n.status===r)),c&&(s=s.filter(n=>n.type===c)),c||(s=s.filter(n=>n.type!=="Dealer")),V&&(s=s.filter(n=>Array.isArray(n.tags)&&n.tags.includes("dealer_upload")));const t=h?new Date(h):null,a=x?new Date(x):null;return t&&(s=s.filter(n=>new Date(n.createdAt)>=t)),a&&(a.setHours(23,59,59,999),s=s.filter(n=>new Date(n.createdAt)<=a)),s},[m,l,r,c,h,x]),W=[{key:"name",header:"Name"},{key:"email",header:"Email"},{key:"company",header:"Company"},{key:"type",header:"Type"},{key:"tags",header:"Tags",render:s=>e.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap"},children:[(s.tags||[]).map((t,a)=>e.jsx("span",{style:{padding:"2px 6px",borderRadius:999,background:"rgba(255,255,255,0.06)",border:"1px solid #334",fontSize:12},children:t},a)),(!s.tags||s.tags.length===0)&&e.jsx("span",{style:{color:"#7a8a9a"},children:"—"})]})},{key:"status",header:"Status",render:s=>e.jsxs("div",{style:{position:"relative"},children:[e.jsx("button",{onClick:t=>{t.stopPropagation(),L(a=>a===s.id?null:s.id)},style:{padding:"4px 8px",borderRadius:999,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:e.jsx(N,{status:s.status})}),z===s.id&&e.jsx("div",{style:{position:"absolute",top:"110%",left:0,background:"#0E1621",border:"1px solid #223",borderRadius:8,padding:6,display:"grid",gap:4,zIndex:10},children:["In Review","Qualified","Closed"].map(t=>e.jsx("button",{onClick:a=>{a.stopPropagation(),A(s.id,t),L(null)},style:{textAlign:"left",padding:"6px 8px",borderRadius:6,border:"1px solid #233140",background:s.status===t?"#132030":"#0B1117",color:"#E6E6E6"},children:t},t))})]})},{key:"createdAt",header:"Created"},{key:"actions",header:"",render:s=>e.jsxs("div",{style:{display:"flex",gap:6},children:[e.jsx("button",{onClick:t=>{t.stopPropagation(),R(s),E(!0)},style:{padding:"4px 8px",border:"1px solid #334",borderRadius:8},children:"Edit"}),e.jsx("button",{onClick:t=>{t.stopPropagation();const a=s.status==="New"?"In Review":s.status==="In Review"?"Qualified":s.status==="Qualified"?"Closed":"New";A(s.id,a)},style:{padding:"4px 8px",border:"1px solid #334",borderRadius:8},children:"Status"}),s.type==="Dealer"&&s.status!=="Qualified"&&e.jsx("button",{onClick:async t=>{t.stopPropagation();try{await b.post(`/leads/${s.id}/accept-dealer`),u(a=>a.map(n=>n.id===s.id?{...n,status:"Qualified",tags:Array.from(new Set([...n.tags||[],"accepted"]))}:n)),alert("Dealer accepted. The user can now log in with email + phone.")}catch{alert("Failed to accept dealer")}},style:{padding:"4px 8px",border:"1px solid #334",borderRadius:8},children:"Accept Dealer"}),e.jsx("button",{onClick:t=>{t.stopPropagation(),$(s.id)},style:{padding:"4px 8px",border:"1px solid #334",borderRadius:8},children:"Delete"})]})}],q=s=>{R(s),k(!0)},_=()=>{const s=new Blob([te(O)],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(s),a=document.createElement("a");a.href=t,a.download="leads.csv",a.click(),URL.revokeObjectURL(t)},H=async()=>{if(S.length===0)return alert("Select rows first");if(!confirm(`Delete ${S.length} lead(s)?`))return;const s=[...S],t=m;u(a=>a.filter(n=>!s.includes(n.id))),I([]);try{await b.post("/leads/bulk-delete",{ids:s})}catch{u(t),alert("Failed to bulk delete")}},G=e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"end",flexWrap:"wrap"},children:[e.jsx(Y,{label:"Search",value:l,onChange:s=>p(s.target.value),placeholder:"Name, email, company"}),e.jsxs("label",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"#C5C6C7"},children:"Status"}),e.jsxs("select",{value:r,onChange:s=>o(s.target.value||""),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{children:"New"}),e.jsx("option",{children:"In Review"}),e.jsx("option",{children:"Qualified"}),e.jsx("option",{children:"Closed"})]})]}),e.jsxs("label",{style:{display:"grid",gap:6},children:[e.jsx("div",{style:{fontSize:12,color:"#C5C6C7"},children:"Type"}),e.jsxs("select",{value:c,onChange:s=>f(s.target.value||""),style:{padding:"10px 12px",borderRadius:8,border:"1px solid #334",background:"#0B1117",color:"#E6E6E6"},children:[e.jsx("option",{value:"",children:"All"}),e.jsx("option",{children:"Prototype"}),e.jsx("option",{children:"Dealer"}),e.jsx("option",{children:"Media"}),e.jsx("option",{children:"Other"})]})]}),e.jsx(C,{onClick:_,variant:"secondary",children:"Export CSV"}),e.jsx(C,{onClick:H,variant:"ghost",children:"Delete Selected"}),e.jsx(C,{onClick:()=>D(!0),children:"Add Lead"})]}),J=[{key:"select",header:"",render:s=>e.jsx("input",{type:"checkbox",checked:S.includes(s.id),onChange:t=>{I(a=>t.target.checked?[...a,s.id]:a.filter(n=>n!==s.id))}})},...W];return e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsx("h1",{children:"Leads"}),e.jsx(X,{columns:J,rows:O,toolbar:G,density:"compact",onRowClick:q}),e.jsx(se,{open:U,onClose:()=>k(!1),title:i?`${i.name}`:"Lead",children:i?e.jsxs("div",{style:{display:"grid",gap:8},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx(N,{status:i.status}),e.jsxs("select",{value:i.owner||"Unassigned",onChange:s=>u(t=>t.map(a=>a.id===i.id?{...a,owner:s.target.value}:a)),children:[e.jsx("option",{children:"Unassigned"}),e.jsx("option",{children:"Admin"}),e.jsx("option",{children:"Marketing"})]})]}),e.jsxs("div",{children:["Email: ",i.email]}),e.jsxs("div",{children:["Phone: ",i.phone||"—"]}),e.jsxs("div",{children:["Company: ",i.company||"—"]}),e.jsxs("div",{children:["Country: ",i.country||"—"]}),e.jsxs("div",{children:["Type: ",i.type]}),e.jsxs("div",{children:["Message: ",i.message||"—"]}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:8},children:[e.jsx(C,{onClick:()=>E(!0),children:"Edit"}),e.jsx(C,{variant:"secondary",onClick:()=>A(i.id,i.status==="New"?"In Review":"Qualified"),children:"Change Status"}),e.jsx(C,{variant:"ghost",onClick:()=>{confirm("Delete lead?")&&(u(s=>s.filter(t=>t.id!==i.id)),k(!1))},children:"Delete"})]}),e.jsx("hr",{style:{borderColor:"#223"}}),e.jsx("strong",{children:"Timeline"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Created • ",i.createdAt]}),e.jsxs("li",{children:["Status: ",i.status]})]})]}):"No lead selected"}),B&&i&&e.jsx(ne,{initial:i,onClose:()=>E(!1),onSave:async s=>{const t=i.id,a=m;u(n=>n.map(j=>j.id===t?{...j,...s}:j));try{await b.patch(`/leads/${t}`,s)}catch{u(a),alert("Failed to save")}E(!1)}}),Q&&e.jsx(le,{onClose:()=>D(!1),onCreate:async s=>{try{const t=await b.post("/leads",s);u(a=>[t,...a])}catch{alert("Failed to create lead")}finally{D(!1)}}})]})}function ne({initial:l,onClose:p,onSave:r}){var x,w;const{register:o,handleSubmit:c,formState:{errors:f,isSubmitting:h}}=P({resolver:T(F),defaultValues:{name:l.name,email:l.email,phone:l.phone,company:l.company,country:l.country,type:l.type,message:l.message,tags:l.tags||[],status:l.status,owner:l.owner}}),v=m=>r(m);return e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"grid",placeItems:"center",zIndex:50},children:e.jsxs("form",{onSubmit:c(v),style:{background:"#0E1621",border:"1px solid #223",borderRadius:12,width:640,maxWidth:"96vw",padding:16,display:"grid",gap:10},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("strong",{children:"Edit Lead"}),e.jsx("button",{type:"button",onClick:p,style:{background:"transparent",border:"1px solid #334",borderRadius:8,color:"#C5C6C7",padding:"6px 10px"},children:"Close"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:10},children:[e.jsxs("label",{children:["Name",e.jsx(y,{reg:o("name"),error:(x=f.name)==null?void 0:x.message})]}),e.jsxs("label",{children:["Email",e.jsx(y,{type:"email",reg:o("email"),error:(w=f.email)==null?void 0:w.message})]}),e.jsxs("label",{children:["Phone",e.jsx(y,{reg:o("phone")})]}),e.jsxs("label",{children:["Company",e.jsx(y,{reg:o("company")})]}),e.jsxs("label",{children:["Country",e.jsx(y,{reg:o("country")})]}),e.jsxs("label",{children:["Type",e.jsxs("select",{...o("type"),children:[e.jsx("option",{children:"Prototype"}),e.jsx("option",{children:"Dealer"}),e.jsx("option",{children:"Media"}),e.jsx("option",{children:"Other"})]})]}),e.jsxs("label",{children:["Status",e.jsxs("select",{...o("status"),children:[e.jsx("option",{children:"New"}),e.jsx("option",{children:"In Review"}),e.jsx("option",{children:"Qualified"}),e.jsx("option",{children:"Closed"})]})]}),e.jsxs("label",{children:["Owner",e.jsxs("select",{...o("owner"),children:[e.jsx("option",{children:"Unassigned"}),e.jsx("option",{children:"Admin"}),e.jsx("option",{children:"Marketing"})]})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:["Message",e.jsx("textarea",{rows:4,...o("message")})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",onClick:p,style:{padding:"8px 12px",border:"1px solid #334",borderRadius:8},children:"Cancel"}),e.jsx("button",{disabled:h,type:"submit",style:{padding:"8px 12px",border:"1px solid #334",borderRadius:8,background:"var(--accent)",color:"#fff"},children:"Save"})]})]})})}function le({onClose:l,onCreate:p}){var v,x;const{register:r,handleSubmit:o,formState:{errors:c,isSubmitting:f}}=P({resolver:T(F),defaultValues:{name:"",email:"",phone:"",company:"",country:"",type:"Prototype",message:"",tags:[],status:"New",owner:"Unassigned"}}),h=w=>p(w);return e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"grid",placeItems:"center",zIndex:50},children:e.jsxs("form",{onSubmit:o(h),style:{background:"#0E1621",border:"1px solid #223",borderRadius:12,width:640,maxWidth:"96vw",padding:16,display:"grid",gap:10},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("strong",{children:"Create Lead"}),e.jsx("button",{type:"button",onClick:l,style:{background:"transparent",border:"1px solid #334",borderRadius:8,color:"#C5C6C7",padding:"6px 10px"},children:"Close"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:10},children:[e.jsxs("label",{children:["Name",e.jsx(y,{reg:r("name"),error:(v=c.name)==null?void 0:v.message})]}),e.jsxs("label",{children:["Email",e.jsx(y,{type:"email",reg:r("email"),error:(x=c.email)==null?void 0:x.message})]}),e.jsxs("label",{children:["Phone",e.jsx(y,{reg:r("phone")})]}),e.jsxs("label",{children:["Company",e.jsx(y,{reg:r("company")})]}),e.jsxs("label",{children:["Country",e.jsx(y,{reg:r("country")})]}),e.jsxs("label",{children:["Type",e.jsxs("select",{...r("type"),children:[e.jsx("option",{children:"Prototype"}),e.jsx("option",{children:"Dealer"}),e.jsx("option",{children:"Media"}),e.jsx("option",{children:"Other"})]})]}),e.jsxs("label",{children:["Status",e.jsxs("select",{...r("status"),children:[e.jsx("option",{children:"New"}),e.jsx("option",{children:"In Review"}),e.jsx("option",{children:"Qualified"}),e.jsx("option",{children:"Closed"})]})]}),e.jsxs("label",{children:["Owner",e.jsxs("select",{...r("owner"),children:[e.jsx("option",{children:"Unassigned"}),e.jsx("option",{children:"Admin"}),e.jsx("option",{children:"Marketing"})]})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:["Message",e.jsx("textarea",{rows:4,...r("message")})]})]}),e.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[e.jsx("button",{type:"button",onClick:l,style:{padding:"8px 12px",border:"1px solid #334",borderRadius:8},children:"Cancel"}),e.jsx("button",{disabled:f,type:"submit",style:{padding:"8px 12px",border:"1px solid #334",borderRadius:8,background:"var(--accent)",color:"#fff"},children:"Create"})]})]})})}function y({reg:l,error:p,type:r="text"}){return e.jsxs(e.Fragment,{children:[e.jsx("input",{type:r,...l,style:{padding:"10px 12px",borderRadius:8,border:"1px solid "+(p?"#AA2E2E":"#334"),background:"#0B1117",color:"#E6E6E6"}}),p&&e.jsx("div",{style:{color:"#FF6B6B",fontSize:12},children:p})]})}export{he as default};
